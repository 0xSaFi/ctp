\subsection{Distributed multipole analysis}
\label{sec:distributed_multipoles}
\index{distributed multipoles}
\index{site energy!distributed multipoles}

% Breakdown of single-point expansion at short interseparation: Solve using distributed multipoles

% \begin{figure*}
% \begin{center}
%     \includegraphics[width=0.5\linewidth]{3_free_energy/fig/dcv2t_esp_contours_summary/summary}
%     \caption{ (a) Contour plot of the DCV2T molecular charge density in atomic units, calculated from DFT-B3LYP/6-311g(d,p). (b) ESP as calculated from the continuous QM charge density. Circles indicate nuclei positions (S = yellow, N = green, C = black, H = white). (c) ESP generated by the set of distributed multipoles allocated to atomic polar sites via the DMA approach. (d) Deviation (rms) of the potential difference upon charging, comparing the change in ESP as approximated by the DMA multipoles against the SCF-computed ESP difference. }
%     \label{fig:ch4_esp_contours}
% \end{center}
% \end{figure*}

In eq.~\ref{equ:mol_centered_U}, we have given an expression for the electrostatic interaction energy in terms of {\em molecule-centered} multipole moments. To arrive at this expression, we required the separation between the molecular centers, $|\vec{X}-\vec{Y}|$, to be larger than the separation of any of the respective charge-carrying volume elements of the two molecules, $|\vec{x}-\vec{y}|$. In a molecular solid, this demand can hardly be satisfied, considering the dense packing and (also important) strongly anisotropic charge density (see, for example, the charge density of a DCV2T molecule in fig.~\ref{fig:ch4_esp_contours}a). This inevitably leads to the breakdown of the single-point expansion at small interseparations. It is possible to avoid this breakdown by choosing multiple expansion sites (``polar sites'') per molecule in such a way as to accurately represent the molecular electrostatic potential (ESP), with a set of suitably chosen multipole moments $\{Q_{lk}^a\}$ allocated to each site. We then simply extend the expression for the interaction energy between two molecules $A$ and $B$ in the single-point expansion, eq.~\ref{equ:mol_centered_U}, and include the sum over expansion sites $a\epsilon A$ and $b\epsilon B$,
\begin{align}
 U_{AB} & = \sum_{a\epsilon A} \sum_{b\epsilon B} \hat{Q}_{l_1k_1}^a T_{l_1k_1l_2k_2}^{a,b} \hat{Q}_{l_2k_2}^b \equiv  \hat{Q}_{l_1k_1}^a T_{l_1k_1l_2k_2}^{a,b} \hat{Q}_{l_2k_2}^b,
 \label{equ:mol_distributed_U}
\end{align}
where we have used the Einstein sum convention for the site indices $a$ and $b$ on the right-hand side of the equation, in addition to the sum convention that is already in place for the multipole-moment components.

The are a number of strategies how to arrive at such a collection of {\em distributed multipoles}~\cite{stone_theory_1997,verstraelen_assessment_2012,breneman_determining_1990,stone_distributed_1985,stone_distributed_2005}. They can be classified according to whether the multipoles are derived (a) from the electrostatic potential generated by the SCF charge density or (b) from a decomposition of the wavefunction itself. Here, we will review two of those approaches, CHELPG~\cite{breneman_determining_1990} from category (a) and DMA~\cite{stone_distributed_1985} from category (b), and put their performance to the test for our DCV2T molecule.

The CHELPG (CHarges from ELectrostatic Potentials, Grid-based) method relies on performing a least-squares fit of atom-placed charges to reproduce the electrostatic potential as evaluated from the SCF density on a regularly spaced grid~\cite{breneman_determining_1990}. The fitted charges result from minimizing the Lagrangian function~\cite{chirlian_atomic_1987}
\begin{align}
 z(\{q_i\}) = \sum_{k=1}^M \left( \phi(\vec{r}_k) - \sum_{i=1}^N \frac{1}{4\pi\varepsilon_0} \frac{q_i}{|\vec{r}_i-\vec{r}_k|} \right) + \lambda \left( q_\textrm{mol} - \sum_{i=1}^N q_i \right),
\end{align}
with $M$ grid points, $N$ atomic sites, the set of atomic partial charges $\{q_i\}$ and the SCF potential $\phi$ from eq.~\ref{equ:scf_potential}. The Lagrange multiplier $\lambda$ constrains the sum of the fitted charges to the molecular charge $q_\textrm{mol}$. The main difference from other fitting schemes~\cite{singh_approach_1984} is the algorithm that selects the positions at which the potential is evaluated (we note that the choice of grid points can have substantial effects especially for bulky molecules).
Clearly, the CHELPG method can be (and has been) extended to include higher atomic multipoles. We will see, however, how already the inclusion of atomic dipoles hardly improves the parametrization, and can in fact be harmful to its conformational stability.

The Distributed-Multipole-Analysis (DMA) approach~\cite{stone_distributed_1985, stone_distributed_2005}, developed by A. Stone, operates directly on the quantum-mechanical density matrix, expanded in terms of atom- and bond-centered Gaussian functions $\chi_\alpha = R_{LK}(\vec{x}-\vec{s}_\alpha) \exp[-\zeta(\vec{x}-\vec{s}_\alpha)^2]$,
\begin{align}
 \rho(\vec{x}) = \sum_{\alpha,\beta} \rho_{\alpha\beta} \chi_\alpha(\vec{x}-\vec{s}_\alpha) \chi_\beta(\vec{x}-\vec{s}_\beta). 
\end{align}
The aim is to compute multipole moments according to eq.~\ref{equ:spherical_moments} in a distributed fashion: If we use that the overlap product $\chi_\alpha \chi_\beta$ of two Gaussian basis functions yields itself a Gaussian centered at $\vec{P} = (\zeta_\alpha \vec{s}_\alpha + \zeta_\beta \vec{s}_\beta) / (\zeta_\alpha + \zeta_\beta)$, it is possible to proceed in two steps: First, we compute the multipole moments associated with a specific summand in the density matrix, referred to the overlap center $\vec{P}$:
\begin{align}
 Q_{LK}[\vec{P}] = - \int R_{LK}(\vec{x}-\vec{P}) \rho_{\alpha\beta} \chi_\alpha \chi_\beta d^3\!x.
\end{align}
Second, we transfer the resulting $Q_{lk}[\vec{P}]$ to the position $\vec{S}$ of a polar site according to the rule~\cite{stone_distributed_1985}
\begin{align}
 Q_{nm}[\vec{S}] = \sum_{l=0}^L \sum_{k=-l}^l \left[ \left(\begin{array}{c} n+m \\ l+k \end{array}\right)\left(\begin{array}{c} n-m \\ l-k \end{array}\right) \right]^{1/2} R_{n-l,m-k}(\vec{S}-\vec{P})\cdot Q_{lk}[\vec{P}].
\end{align}
Note how this requires a rule for the choice of the expansion site to which the multipole moment should be transferred. In the near past~\cite{stone_distributed_2005}, the nearest-site algorithm, which allocates the multipole moments to the site closest to the overlap center, has been replaced for diffuse functions by an algorithm based on a smooth weighting function in conjunction with grid-based integration methods in order to decrease the basis-set dependence of the resulting set of distributed multipoles.